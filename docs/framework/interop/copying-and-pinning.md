---
title: Kopyalama ve Sabitleme
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- pinning, interop marshaling
- copying, interop marshaling
- interop marshaling, copying
- interop marshaling, pinning
ms.assetid: 0059f576-e460-4e70-b257-668870e420b8
caps.latest.revision: "8"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: 5014bcc0696a8650bed1d00d1224c892660c041e
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 12/22/2017
---
# <a name="copying-and-pinning"></a><span data-ttu-id="d8782-102">Kopyalama ve Sabitleme</span><span class="sxs-lookup"><span data-stu-id="d8782-102">Copying and Pinning</span></span>
<span data-ttu-id="d8782-103">Verileri hazırlama, birlikte çalışabilirlik Sıralayıcı kopyalayabilir veya sıralanmış veri sabitleyin.</span><span class="sxs-lookup"><span data-stu-id="d8782-103">When marshaling data, the interop marshaler can copy or pin the data being marshaled.</span></span> <span data-ttu-id="d8782-104">Veri kopyalama verilerin bir kopyasını tek bir yerden bellek başka bir bellek konuma yerleştirir.</span><span class="sxs-lookup"><span data-stu-id="d8782-104">Copying the data places a copy of data from one memory location in another memory location.</span></span> <span data-ttu-id="d8782-105">Bir değer türü kopyalama arasındaki farklar aşağıda gösterilmiştir ve bir tür kopyalama başvuruya göre yönetilmeyen bellek yönetilen geçirildi.</span><span class="sxs-lookup"><span data-stu-id="d8782-105">The following illustration shows the differences between copying a value type and copying a type passed by reference from managed to unmanaged memory.</span></span>  
  
 <span data-ttu-id="d8782-106">![Değer türleri değer ve başvuru tarafından geçirilen](../../../docs/framework/interop/media/interopmarshalcopy.gif "interopmarshalcopy")</span><span class="sxs-lookup"><span data-stu-id="d8782-106">![Value types passed by value and by reference](../../../docs/framework/interop/media/interopmarshalcopy.gif "interopmarshalcopy")</span></span>  
<span data-ttu-id="d8782-107">Değer ve başvuru tarafından geçirilen değer türleri</span><span class="sxs-lookup"><span data-stu-id="d8782-107">Value types passed by value and by reference</span></span>  
  
 <span data-ttu-id="d8782-108">Yöntem bağımsız değişkenleri değere göre geçirilen yönetilmeyen koda yığında değerleri olarak hazırlanırlar.</span><span class="sxs-lookup"><span data-stu-id="d8782-108">Method arguments passed by value are marshaled to unmanaged code as values on the stack.</span></span> <span data-ttu-id="d8782-109">Kopyalama doğrudan bir işlemdir.</span><span class="sxs-lookup"><span data-stu-id="d8782-109">The copying process is direct.</span></span> <span data-ttu-id="d8782-110">Başvuruya göre geçirilen bağımsız değişkenler işaretçileri yığında geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-110">Arguments passed by reference are passed as pointers on the stack.</span></span> <span data-ttu-id="d8782-111">Başvuru türleri de değer ve başvuru tarafından geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-111">Reference types are also passed by value and by reference.</span></span> <span data-ttu-id="d8782-112">Aşağıdaki çizimde gösterildiği gibi değeri tarafından geçirilen başvuru türleri kopyalanan sabitlenmiş ya.</span><span class="sxs-lookup"><span data-stu-id="d8782-112">As the following illustration shows, reference types passed by value are either copied or pinned.</span></span>  
  
 <span data-ttu-id="d8782-113">![COM birlikte çalışma](../../../docs/framework/interop/media/interopmarshalpin.gif "interopmarshalpin")</span><span class="sxs-lookup"><span data-stu-id="d8782-113">![COM interop](../../../docs/framework/interop/media/interopmarshalpin.gif "interopmarshalpin")</span></span>  
<span data-ttu-id="d8782-114">Değer ve başvuru tarafından geçirilen başvuru türleri</span><span class="sxs-lookup"><span data-stu-id="d8782-114">Reference types passed by value and by reference</span></span>  
  
 <span data-ttu-id="d8782-115">Bu nedenle ortak dil çalışma zamanındaki atık toplayıcısı tarafından yeniden konumlandırılmasını tutma geçerli bellek konumuna verileri geçici olarak sabitleme kilitler.</span><span class="sxs-lookup"><span data-stu-id="d8782-115">Pinning temporarily locks the data in its current memory location, thus keeping it from being relocated by the common language runtime's garbage collector.</span></span> <span data-ttu-id="d8782-116">Sıralayıcı kopyalama yükünü azaltmak ve performansı geliştirmek için veri sabitler.</span><span class="sxs-lookup"><span data-stu-id="d8782-116">The marshaler pins data to reduce the overhead of copying and enhance performance.</span></span> <span data-ttu-id="d8782-117">Veri türü kopyaladığınız veya Hazırlama işlemi sırasında sabitlenmiş olup olmadığını belirler.</span><span class="sxs-lookup"><span data-stu-id="d8782-117">The type of the data determines whether it is copied or pinned during the marshaling process.</span></span>  <span data-ttu-id="d8782-118">Sabitleme otomatik olarak gerçekleştirilir gibi nesneler için sıralama sırasında <xref:System.String>, bellek kullanarak el ile de sabitleyebilirsiniz ancak <xref:System.Runtime.InteropServices.GCHandle> sınıfı.</span><span class="sxs-lookup"><span data-stu-id="d8782-118">Pinning is automatically performed during marshaling for objects such as <xref:System.String>, however you can also manually pin memory using the <xref:System.Runtime.InteropServices.GCHandle> class.</span></span>  
  
## <a name="formatted-blittable-classes"></a><span data-ttu-id="d8782-119">Biçimlendirilmiş Blittable sınıfları</span><span class="sxs-lookup"><span data-stu-id="d8782-119">Formatted Blittable Classes</span></span>  
 <span data-ttu-id="d8782-120">Biçimlendirilmiş [blittable](../../../docs/framework/interop/blittable-and-non-blittable-types.md) sınıfları (biçimlendirilmiş) düzeni sabit ve hem de genel veri temsili yönetilen ve yönetilmeyen bellek.</span><span class="sxs-lookup"><span data-stu-id="d8782-120">Formatted [blittable](../../../docs/framework/interop/blittable-and-non-blittable-types.md) classes have fixed layout (formatted) and common data representation in both managed and unmanaged memory.</span></span> <span data-ttu-id="d8782-121">Bu tür hazırlama gerektirdiğinde, öbek nesnesinde bir işaretçi Aranan doğrudan geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-121">When these types require marshaling, a pointer to the object in the heap is passed to the callee directly.</span></span> <span data-ttu-id="d8782-122">Aranan işaretçiyi tarafından başvurulan bellek konumuna içeriğini değiştirebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="d8782-122">The callee can change the contents of the memory location being referenced by the pointer.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="d8782-123">Çıkış veya giriş/çıkış parametresi işaretlenmişse Aranan bellek içeriğini değiştirebilirsiniz. Buna karşılık, aranan gibi sıralamakta parametresi ayarlandığında içeriğini değiştirme biçimlendirilmiş blittable türleri için varsayılan değer olan kaçınmalısınız.</span><span class="sxs-lookup"><span data-stu-id="d8782-123">The callee can change the memory contents if the parameter is marked Out or In/Out. In contrast, the callee should avoid changing the contents when the parameter is set to marshal as In, which is the default for formatted blittable types.</span></span> <span data-ttu-id="d8782-124">In nesneyi değiştirme aynı sınıf için bir tür kitaplığı dışarı aktardığınızda sorunları oluşturur ve arası grup çağrı yapmak için kullanılır.</span><span class="sxs-lookup"><span data-stu-id="d8782-124">Modifying an In object generates problems when the same class is exported to a type library and used to make cross-apartment calls.</span></span>  
  
## <a name="formatted-non-blittable-classes"></a><span data-ttu-id="d8782-125">Biçimlendirilmiş Blittable olmayan sınıfları</span><span class="sxs-lookup"><span data-stu-id="d8782-125">Formatted Non-Blittable Classes</span></span>  
 <span data-ttu-id="d8782-126">Biçimlendirilmiş [blittable olmayan](../../../docs/framework/interop/blittable-and-non-blittable-types.md) sınıfları (biçimlendirilmiş) düzeni sabit ancak veri temsili yönetilen ve yönetilmeyen bellekte farklıdır.</span><span class="sxs-lookup"><span data-stu-id="d8782-126">Formatted [non-blittable](../../../docs/framework/interop/blittable-and-non-blittable-types.md) classes have fixed layout (formatted) but the data representation is different in managed and unmanaged memory.</span></span> <span data-ttu-id="d8782-127">Veri dönüştürme aşağıdaki koşullarda gerektirebilir:</span><span class="sxs-lookup"><span data-stu-id="d8782-127">The data can require transformation under the following conditions:</span></span>  
  
-   <span data-ttu-id="d8782-128">Blittable olmayan sınıf değerine göre sıralanmış, aranan veri yapısının bir işaretçi alır.</span><span class="sxs-lookup"><span data-stu-id="d8782-128">If a non-blittable class is marshaled by value, the callee receives a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="d8782-129">Blittable olmayan sınıf başvuruya göre sıralanmış, aranan veri yapısının bir işaretçi bir işaretçi alır.</span><span class="sxs-lookup"><span data-stu-id="d8782-129">If a non-blittable class is marshaled by reference, the callee receives a pointer to a pointer to a copy of the data structure.</span></span>  
  
-   <span data-ttu-id="d8782-130">Varsa <xref:System.Runtime.InteropServices.InAttribute> özniteliği olarak ayarlanmış, bu kopya her zaman gerektiği şekilde hazırlama örneğinin durumuyla başlatılır.</span><span class="sxs-lookup"><span data-stu-id="d8782-130">If the <xref:System.Runtime.InteropServices.InAttribute> attribute is set, this copy is always initialized with the instance's state, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="d8782-131">Varsa <xref:System.Runtime.InteropServices.OutAttribute> özniteliği olarak ayarlanmışsa, durumu her zaman gerektiği şekilde hazırlama dönüşte örneğine kopyalanır.</span><span class="sxs-lookup"><span data-stu-id="d8782-131">If the <xref:System.Runtime.InteropServices.OutAttribute> attribute is set, the state is always copied back to the instance on return, marshaling as necessary.</span></span>  
  
-   <span data-ttu-id="d8782-132">Her iki **InAttribute** ve **OutAttribute** , her iki kopya gerekli ayarlanmıştır.</span><span class="sxs-lookup"><span data-stu-id="d8782-132">If both **InAttribute** and **OutAttribute** are set, both copies are required.</span></span> <span data-ttu-id="d8782-133">Her iki öznitelik atlanırsa, Sıralayıcı ya da kopyalama ortadan kaldırarak en iyi duruma getirebilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="d8782-133">If either attribute is omitted, the marshaler can optimize by eliminating either copy.</span></span>  
  
## <a name="reference-types"></a><span data-ttu-id="d8782-134">Başvuru Türleri</span><span class="sxs-lookup"><span data-stu-id="d8782-134">Reference Types</span></span>  
 <span data-ttu-id="d8782-135">Başvuru türleri değere veya başvuruya göre geçirilebilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-135">Reference types can be passed by value or by reference.</span></span> <span data-ttu-id="d8782-136">Değere göre geçirildiğinde türü için bir işaretçi yığında geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-136">When they are passed by value, a pointer to the type is passed on the stack.</span></span> <span data-ttu-id="d8782-137">Başvuruya göre geçirildiğinde türü için bir işaretçi bir işaretçi yığında geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-137">When passed by reference, a pointer to a pointer to the type is passed on the stack.</span></span>  
  
 <span data-ttu-id="d8782-138">Başvuru türleri aşağıdaki koşullu davranışı vardır:</span><span class="sxs-lookup"><span data-stu-id="d8782-138">Reference types have the following conditional behavior:</span></span>  
  
-   <span data-ttu-id="d8782-139">Bir başvuru türü değeri geçirilir ve kopyalanamaz türler üyeleri sahipse, türleri iki kez dönüştürülür:</span><span class="sxs-lookup"><span data-stu-id="d8782-139">If a reference type is passed by value and it has members of non-blittable types, the types are converted twice:</span></span>  
  
    -   <span data-ttu-id="d8782-140">Ne zaman bir bağımsız değişken yönetilmeyen tarafa geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-140">When an argument is passed to the unmanaged side.</span></span>  
  
    -   <span data-ttu-id="d8782-141">Çağrısından getirisi.</span><span class="sxs-lookup"><span data-stu-id="d8782-141">On return from the call.</span></span>  
  
     <span data-ttu-id="d8782-142">Önlemek için gereksiz yere kopyalama ve dönüştürme, bu tür olarak sıralanmış parametreleri.</span><span class="sxs-lookup"><span data-stu-id="d8782-142">To avoid unnecessarily copying and conversion, these types are marshaled as In parameters.</span></span> <span data-ttu-id="d8782-143">Açıkça uygulamalısınız **InAttribute** ve **OutAttribute** öznitelikleri Aranan tarafından yapılan değişiklikleri görmek arayan için bağımsız değişken için.</span><span class="sxs-lookup"><span data-stu-id="d8782-143">You must explicitly apply the **InAttribute** and **OutAttribute** attributes to an argument for the caller to see changes made by the callee.</span></span>  
  
-   <span data-ttu-id="d8782-144">Bir başvuru türü değeri tarafından iletilir ve yalnızca blittable türleri üyeleri varsa, sıralama sırasında sabitlenmelidir ve türün üyeleri Aranan tarafından yapılan değişiklikler çağıran tarafından görülür.</span><span class="sxs-lookup"><span data-stu-id="d8782-144">If a reference type is passed by value and it has only members of blittable types, it can be pinned during marshaling and any changes made to the members of the type by the callee are seen by the caller.</span></span> <span data-ttu-id="d8782-145">Uygulama **InAttribute** ve **OutAttribute** açıkça Bu davranış istiyorsanız.</span><span class="sxs-lookup"><span data-stu-id="d8782-145">Apply **InAttribute** and **OutAttribute** explicitly if you want this behavior.</span></span> <span data-ttu-id="d8782-146">Tek yönlü özniteliklerden, tür kitaplığına yön bilgilerini birlikte çalışma Sıralayıcı vermez (bunu gibi varsayılan olan aktarır) ve bu COM arası grup sıralama ile ilgili sorunlara neden olabilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-146">Without these directional attributes, the interop marshaler does not export directional information to the type library (it exports as In, which is the default) and this can cause problems with COM cross-apartment marshaling.</span></span>  
  
-   <span data-ttu-id="d8782-147">Bir başvuru türü başvuruya göre aktarılırsa, olarak giriş/çıkış varsayılan olarak sıralanacağını.</span><span class="sxs-lookup"><span data-stu-id="d8782-147">If a reference type is passed by reference, it will be marshaled as In/Out by default.</span></span>  
  
## <a name="systemstring-and-systemtextstringbuilder"></a><span data-ttu-id="d8782-148">System.String ve System.Text.StringBuilder</span><span class="sxs-lookup"><span data-stu-id="d8782-148">System.String and System.Text.StringBuilder</span></span>  
 <span data-ttu-id="d8782-149">Veri yönetilmeyen koda değere veya başvuruya göre sıralanmış olduğundan, Sıralayıcı, genellikle verileri (büyük olasılıkla karakter kümesi kopyalama sırasında dönüştürme) ikincil bir arabellek kopyalar ve arabellek başvuru Aranan geçirir.</span><span class="sxs-lookup"><span data-stu-id="d8782-149">When data is marshaled to unmanaged code by value or by reference, the marshaler typically copies the data to a secondary buffer (possibly converting character sets during the copy) and passes a reference to the buffer to the callee.</span></span> <span data-ttu-id="d8782-150">Başvuru olmadığı sürece bir **BSTR** ile ayrılan **SysAllocString**, başvuru ile her zaman ayrılır **CoTaskMemAlloc**.</span><span class="sxs-lookup"><span data-stu-id="d8782-150">Unless the reference is a **BSTR** allocated with **SysAllocString**, the reference is always allocated with **CoTaskMemAlloc**.</span></span>  
  
 <span data-ttu-id="d8782-151">Her iki dize türü (örneğin, Unicode karakter dizesi gibi) değerine göre sıralanmış olduğunda bir iyileştirme Sıralayıcı Aranan doğrudan bir işaretçi için yeni bir arabellek kopyalamak yerine iç Unicode arabellek yönetilen dizelerde geçirir.</span><span class="sxs-lookup"><span data-stu-id="d8782-151">As an optimization when either string type is marshaled by value (such as a Unicode character string), the marshaler passes the callee a direct pointer to managed strings in the internal Unicode buffer instead of copying it to a new buffer.</span></span>  
  
> [!CAUTION]
>  <span data-ttu-id="d8782-152">Bir dize değeriyle geçirildiğinde, aranan hiçbir zaman sıralayıcı tarafından geçirilen başvuru değiştirmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="d8782-152">When a string is passed by value, the callee must never alter the reference passed by the marshaler.</span></span> <span data-ttu-id="d8782-153">Bunun yapılması, yönetilen yığın bozulmasına neden.</span><span class="sxs-lookup"><span data-stu-id="d8782-153">Doing so can corrupt the managed heap.</span></span>  
  
 <span data-ttu-id="d8782-154">Zaman bir <xref:System.String?displayProperty=nameWithType> geçirilen başvuruya göre sıralayıcı içeriği dize için ikincil bir arabellek arama yapmadan önce kopyalar.</span><span class="sxs-lookup"><span data-stu-id="d8782-154">When a <xref:System.String?displayProperty=nameWithType> is passed by reference, the marshaler copies the contents the string to a secondary buffer before making the call.</span></span> <span data-ttu-id="d8782-155">Ardından yeni bir dize çağrısından döndürülen içine arabellek içeriğini kopyalar.</span><span class="sxs-lookup"><span data-stu-id="d8782-155">It then copies the contents of the buffer into a new string on return from the call.</span></span> <span data-ttu-id="d8782-156">Bu teknik değişmez yönetilen dize değiştirilmemiş kalmasını sağlar.</span><span class="sxs-lookup"><span data-stu-id="d8782-156">This technique ensures that the immutable managed string remains unaltered.</span></span>  
  
 <span data-ttu-id="d8782-157">Zaman bir <xref:System.Text.StringBuilder?displayProperty=nameWithType> değeri, iç arabellek başvuru Sıralayıcı geçişleri tarafından geçirilen **StringBuilder** doğrudan çağırana.</span><span class="sxs-lookup"><span data-stu-id="d8782-157">When a <xref:System.Text.StringBuilder?displayProperty=nameWithType> is passed by value, the marshaler passes a reference to the internal buffer of the **StringBuilder** directly to the caller.</span></span> <span data-ttu-id="d8782-158">Çağıran ve çağrılan arabellek boyutunu kabul etmeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="d8782-158">The caller and callee must agree on the size of the buffer.</span></span> <span data-ttu-id="d8782-159">Arayan oluşturmaktan sorumlu bir **StringBuilder** yeterli uzunluğu.</span><span class="sxs-lookup"><span data-stu-id="d8782-159">The caller is responsible for creating a **StringBuilder** of adequate length.</span></span> <span data-ttu-id="d8782-160">Aranan arabellek değil taşması emin olmak için gerekli önlemleri almalıdır.</span><span class="sxs-lookup"><span data-stu-id="d8782-160">The callee must take the necessary precautions to ensure that the buffer is not overrun.</span></span> <span data-ttu-id="d8782-161">**StringBuilder** olduğu değeri tarafından geçirilen türler başvuru kural için bir özel parametreler olduğu gibi varsayılan olarak geçirilir.</span><span class="sxs-lookup"><span data-stu-id="d8782-161">**StringBuilder** is an exception to the rule that reference types passed by value are passed as In parameters by default.</span></span> <span data-ttu-id="d8782-162">Bu her zaman geçirilen olarak giriş/çıkış.</span><span class="sxs-lookup"><span data-stu-id="d8782-162">It is always passed as In/Out.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d8782-163">Ayrıca Bkz.</span><span class="sxs-lookup"><span data-stu-id="d8782-163">See Also</span></span>  
 [<span data-ttu-id="d8782-164">Varsayılan Hazırlama Davranışı</span><span class="sxs-lookup"><span data-stu-id="d8782-164">Default Marshaling Behavior</span></span>](../../../docs/framework/interop/default-marshaling-behavior.md)  
 [<span data-ttu-id="d8782-165">Bellek yönetimi ile birlikte çalışma Sıralayıcı</span><span class="sxs-lookup"><span data-stu-id="d8782-165">Memory Management with the Interop Marshaler</span></span>](http://msdn.microsoft.com/en-us/417206ce-ee3e-4619-9529-0c0b686c7bee)  
 [<span data-ttu-id="d8782-166">Tek yönlü öznitelikleri</span><span class="sxs-lookup"><span data-stu-id="d8782-166">Directional Attributes</span></span>](http://msdn.microsoft.com/en-us/241ac5b5-928e-4969-8f58-1dbc048f9ea2)  
 [<span data-ttu-id="d8782-167">Birlikte Çalışma için Hazırlama</span><span class="sxs-lookup"><span data-stu-id="d8782-167">Interop Marshaling</span></span>](../../../docs/framework/interop/interop-marshaling.md)
